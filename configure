#!/bin/sh -e
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy of
# the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.

PREFIX="/usr/local"
PACKAGE_AUTHOR_NAME="The Apache Software Foundation"
COUCHDB_USER=`whoami`
WITH_CURL="false"

# cd into this scriptâ€™s directory
rootdir="$(cd "${0%/*}" 2>/dev/null; echo "$PWD")"
basename=`basename $0`


display_help () {
    cat << EOF
Usage: $basename [OPTION]

The $basename command is responsible for generating the build
system for Apache CouchDB.

Options:

  -h            display a short help message and exit
  -u USER       set the username to run as (defaults to $COUCHDB_USER)
  -p DIRECTORY  set the prefix for installation (defaults to $PREFIX)
  -d DIRECTORY  specify the data directory (defaults to /var/lib/couchdb)
  -v DIRECTORY  specify the view directory (defaults to /var/lib/couchdb)
  -l FILE       specify the log file (defaults to /var/log/couchdb.log)
  -c            request that couchjs is linked to cURL (default false)

EOF
}


display_error () {
    if test -n "$1"; then
        echo $1 >&2
    fi
    echo >&2
    echo "Try \"$basename -h\" for more information." >&2
    false
}


parse_opts () {
    set +e
    options=`getopt hu:p:d:v:l:c $@`
    if test ! $? -eq 0; then
        display_error
    fi
    set -e
    eval set -- $options
    while [ $# -gt 0 ]; do
        case "$1" in
            -h) shift; display_help; exit;;
            -u) shift; COUCHDB_USER=$1; shift;;
            -p) shift; PREFIX=$1; shift;;
            -d) shift; DATA_DIR=$1; shift;;
            -v) shift; VIEW_DIR=$1; shift;;
            -l) shift; LOG_FILE=$1; shift;;
            -c) shift; WITH_CURL="true";;
            --) shift; break;;
            *) display_error "Unknown option: $1" >&2;;
        esac
    done

    # defaults
    if test -z "$DATA_DIR"; then
        DATA_DIR="/var/lib/couchdb";
    fi
    if test -z "$VIEW_DIR"; then
        VIEW_DIR="/var/lib/couchdb";
    fi
    if test -z "$LOG_FILE"; then
        LOG_FILE="/var/log/couchdb.log";
    fi
}


parse_opts $@

INSTALL_DIR="$PREFIX/couchdb"


echo "==> configuring couchdb in rel/couchdb.config"
cat > rel/couchdb.config << EOF
% Licensed under the Apache License, Version 2.0 (the "License"); you may not
% use this file except in compliance with the License. You may obtain a copy of
% the License at
%
%   http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
% WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
% License for the specific language governing permissions and limitations under
% the License.
%
% The contents of this file are auto-generated by configure
%
{package_author_name, "$PACKAGE_AUTHOR_NAME"}.
{prefix, "INSTALLDIR"}.
{data_dir, "$DATA_DIR"}.
{view_index_dir, "$VIEW_DIR"}.
{log_file, "$LOG_FILE"}.
{user, "$COUCHDB_USER"}.
{node_name, "-name couchdb"}.
{cluster_port, 5984}.
{backend_port, 5986}.
EOF

cat > install.mk << EOF
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy of
# the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.
#
# The contents of this file are auto-generated by configure
#
package_author_name = $PACKAGE_AUTHOR_NAME
install_dir = $INSTALL_DIR
data_dir = $DATA_DIR
view_index_dir = $VIEW_DIR
log_file = $LOG_FILE
user = $COUCHDB_USER
EOF

cat > $rootdir/config.erl << EOF
{with_curl, $WITH_CURL}.
EOF

# only update dependencies, when we are not in a release tarball
if [ -d .git ]; then
  echo "==> updating dependencies"
  rebar get-deps update-deps
fi
